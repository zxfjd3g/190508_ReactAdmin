<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>新旧生命周期比较</title>
</head>
<body>

<div id="example"></div>

<script type="text/javascript" src="../js/react.development.js"></script>
<script type="text/javascript" src="../js/react-dom.development.js"></script>
<script type="text/javascript" src="../js/babel.min.js"></script>

<!-- 
1. 新添加2个方法
    static getDerivedStateFromProps()
    getSnapshotBeforeUpdate()
2. 准备删除的3个方法
    componentWillMount()
    componentWillUpdate()
    componentWillReceiveProps()
-->
<script type="text/babel">

  class LifeTest extends React.Component {
    state = {
      m1: 1
    }

    updateM1 = () => {
      this.setState(state => ({ m1: state.m1 + 1 }))
    }

    render () {
      return (
        <div>
          <button onClick={this.updateM1}>更新m1</button>
          <h1>m1: {this.state.m1}</h1>
          <hr/>
          <OldLife m1={this.state.m1} />
          <hr/>
          <NewLife m1={this.state.m1} />
        </div>
      )
    }
  }

  class OldLife extends React.Component {
    
    constructor (props) {
      super(props)
      console.log('OldLife constructor()')
      this.state = {
        m2: 1
      }
    }

    updateM2 = () => {
      this.setState(state => ({
        m2: state.m2 + 1
      }))
    }

    componentWillMount () {
      console.log('OldLife componentWillMount()---')
    }

    componentDidMount () {
      console.log('OldLife componentDidMount()')
    }

    componentWillUpdate () {
      console.log('OldLife componentWillUpdate()---')
    }

    componentDidUpdate () {
      console.log('OldLife componentDidUpdate()')
    }

    componentWillUnmount () {
      console.log('OldLife componentWillUnmount()')
    }


    componentWillReceiveProps (nextProps) {
      console.log('OldLife componentWillReceiveProps()---')
    }

    shouldComponentUpdate (nextProps, nextState) {
      console.log('OldLife shouldComponentUpdate()', nextProps, nextState)
      return true
    }

    render() {
      console.log('OldLife render()')
      return (
        <div>
          <button onClick={this.updateM2}>OldLife 更新m2</button>
          <h2>m1: {this.props.m1}</h2>
          <h2>m2: {this.state.m2}</h2>
        </div>
      )
    }
  }

  class NewLife extends React.Component {
    constructor (props) {
      super(props)
      console.log('NewLife constructor()')
      const list = []
      while(list.length<50) {
        list.push(list.length)
      }
      this.state = {
        m3: 1,
        list
      }
    }

    updateM3 = () => {
      this.setState(state => ({
        m3: state.m3 + 1
      }))
    }

    add = () => {
      this.setState(state => ({
        list: [...[1, 1, 1, 1, 1, 1, 1, 1], ...state.list]
      }))
    }

    componentDidMount () {
      console.log('NewLife componentDidMount()')
    }

    shouldComponentUpdate (nextProps, nextState) {
      console.log('NewLife shouldComponentUpdate()', nextProps, nextState)
      return true
    }

    componentDidUpdate (prevProps, prevState, snapshot) {
      console.log('NewLife componentDidUpdate()')
    }

    componentWillUnmount () {
      console.log('NewLife componentWillUnmount()')
    }

    static getDerivedStateFromProps (props, state) {
      console.log('NewLife getDerivedStateFromProps()+++', props.m1, state.m3)
      if (props.m1 %3 === 1) {
        return {
          m3: state.m3 + 1
        }
      }

      return null
    }

    getSnapshotBeforeUpdate (prevProps, prevState) {
      console.log('NewLife getSnapshotBeforeUpdate()+++', prevProps, prevState)
      return null
    }

    render() {
      console.log('NewLife render()')
      return (
        <div>
          <button onClick={this.updateM3}>NewLife 更新m3</button>
          <h3>m1: {this.props.m1}</h3>
          <h3>m3: {this.state.m3}</h3>

          <hr/>
          <button onClick={this.add}>添加</button>
          <ScrollingList list={this.state.list}/>
        </div>
      )
    }
  }

  class ScrollingList extends React.Component {
    // props list array

    listRef = React.createRef();

    getSnapshotBeforeUpdate(prevProps, prevState) {
      // 我们是否在 list 中添加新的 items ？
      // 捕获滚动​​位置以便我们稍后调整滚动位置。
      if (prevProps.list.length < this.props.list.length) {
        const list = this.listRef.current;
        console.log('getSnapshotBeforeUpdate', list.scrollHeight, list.scrollTop, list.scrollHeight - list.scrollTop)
        return list.scrollHeight - list.scrollTop;
      }
      return null;
    }

    componentDidUpdate(prevProps, prevState, snapshot) {
      // 如果我们 snapshot 有值，说明我们刚刚添加了新的 items，
      // 调整滚动位置使得这些新 items 不会将旧的 items 推出视图。
      //（这里的 snapshot 是 getSnapshotBeforeUpdate 的返回值）
      if (snapshot !== null) {
        const list = this.listRef.current;
        console.log('componentDidUpdate', list.scrollHeight, list.scrollTop)
        list.scrollTop = list.scrollHeight - snapshot;
        console.log('componentDidUpdate', list.scrollHeight, list.scrollTop)
      }
    }

    render() {
      return (
        <div ref={this.listRef} style={{height: 300, overflowY: 'scroll'}}>
          <ul>
            {
              this.props.list.map((item, index) => <li key={index}>{item}</li>)
            }
          </ul> 
        </div>
      );
    }
  }
  

  ReactDOM.render(<LifeTest/>, document.getElementById('example'))
</script>
</body>
</html>

